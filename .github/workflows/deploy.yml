name: Deploy Public Folder to Server

on:
  # 当代码推送到 main 分支时触发（如果是 master 分支请修改这里）
  push:
    branches:
      - main
  # 允许手动点击按钮触发部署
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 配置 SSH 私钥
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: 'placeholder' # 下一步我们会手动扫描，这里占位即可
          if_key_exists: replace

      # 3. 添加服务器指纹到 known_hosts (防止首次连接询问 yes/no 导致卡死)
      - name: Adding Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 4. 使用 Rsync 同步文件
      - name: Deploy with Rsync
        run: |
          # -a: 归档模式 (保留权限、时间戳等)
          # -v: 显示详细过程
          # -z: 传输时压缩
          # --delete: 删除服务器上存在但 GitHub 上不存在的文件 (保持完全一致)
          # ./public/ 注意末尾的斜杠，表示同步文件夹下的内容，而不是 public 文件夹本身
          
          rsync -avz -e 'ssh -p ${{ secrets.SERVER_PORT }}' --delete ./public/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/lilinfang/test

        
        # 注意：请将 /var/www/html/ 替换为你服务器上的实际路径
        # 如果你使用了 TARGET_DIR secret，可以写成: ${{ secrets.TARGET_DIR }}